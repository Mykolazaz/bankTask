---
title: "Data Visualization Task"
output: pdf_document
date: "`r Sys.Date()`"
---

*Data from subtask1.rmd (Data Manipulation Task) must be loaded into the environment.*

## Packages

```{r}
library(ggplot2)
library(GGally)
library(gridExtra)
library(tidyr)
library(patchwork)
library(bestNormalize)
```

## Visualizing the data

Let's look at the distribution of available continuous variables with regard to whether the client decided to subscribe.

```{r message=FALSE, warning=FALSE}
vars_for_plot <- bank_full %>%
  select(age, balance, duration, campaign, pdays, previous, subscribed)

bank_long <- vars_for_plot %>%
  pivot_longer(cols = -subscribed, names_to = "variable", values_to = "value")

p1 <- ggplot(filter(bank_long, variable == "age"),
                aes(x = value, fill = subscribed)) +
  geom_density(alpha = 0.5) +
  xlim(18, 99) +
  labs(title = "Age", x = "Age", y = "")

p2 <- ggplot(filter(bank_long, variable == "balance"),
                    aes(x = value, fill = subscribed)) +
  geom_density(alpha = 0.5) +
  xlim(-1000, 5500) +
  labs(title = "Balance", x = "Balance", y = "")

p3 <- ggplot(filter(bank_long, variable == "duration"),
                     aes(x = value, fill = subscribed)) +
  geom_density(alpha = 0.5) +
  xlim(0, 1600) +
  labs(title = "Call Duration", x = "Duration", y = "")


final_plot <- (p1 | p2 | p3) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")

final_plot
```

The density plots show us that both age and balance are unlikely meaningful indicators of deposit subscription with the exception of age 60+. On the other hand, call duration seems to tell a different story. Clients that, in the end, decided not to subscribe had shorter conversations with the representative of the bank showing their disinterest early on.

During the data manipulation task we noticed that the balance of contacted clients, when grouped by job, varies a lot. Let's plot the distribution of the balance to make further conclusions.

```{r}
mean(bank_full$balance, na.rm = TRUE)
sd(bank_full$balance)

outliers <- boxplot.stats(bank_full$balance)$out
outlierNum <- length(outliers)
round(outlierNum/(length(bank_full$balance)) * 100, 2)

```

Since the balance variance is relatively high and around 10% of the entries can be marked as outliers, we'll normalize the balance variable using the Yeo-Johnson transformation (similar to Box-Cox but without the non-negative value restriction).

```{r warning=FALSE}
yj <- yeojohnson(bank_full$balance)
bank_full$trans_balance <- predict(yj)

ggplot(bank_full_loged, aes(x = job, y = trans_balance, fill = job)) + 
  geom_boxplot(outlier.size = 0.7, na.rm = TRUE) +
  coord_flip() + 
  stat_summary(fun = mean, geom = "point", shape = 4, size = 0.8, color = "black", na.rm = TRUE) + 
  labs(title = "Distribution of Client Account Balances Reveals High Variance",
       subtitle = "Tranformed Balance Distribution by Job") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
```

The box plots allow us to conclude that the balance of the client accounts is likely dependent more factors than simply their job. It also indicates that the clients grouped by their job type are not homogeneous (as we had to apply Yeo-Johnson transformation to achieve more normal values). Nevertheless we can draw certain conclusions. For example, we can see that the median account balance of students is higher than those of service workers. Another trend is clear - retirees have the highest average and median balance.

One angle that could reveal more valuable information is additional (categorical) client characteristics with regard to whether or not the client has subscribed to a bank deposit.

```{r message=FALSE, warning=FALSE}
cat_vars <- c("job", "marital", "education", "in_default", "housing_loan", 
              "personal_loan", "day", "month", "poutcome")

create_bar_plot <- function(data, var_name) {
  freq_table <- data %>%
    group_by(!!sym(var_name), subscribed) %>%
    summarise(count = n(), .groups = "drop") %>%
    group_by(!!sym(var_name)) %>%
    mutate(prop = count / sum(count))
  
  p <- ggplot(freq_table, aes(x = !!sym(var_name), y = prop, fill = subscribed)) +
    geom_bar(stat = "identity", position = "fill") +
    scale_fill_manual(values = c("TRUE" = "#4CAF50", "FALSE" = "#F44336")) +
    labs(x = var_name,
         y = "",
         fill = "Subscribed") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          plot.title = element_text(size = 10),
          legend.position = "none")
  
  return(p)
}

plot_list <- lapply(cat_vars, function(var) create_bar_plot(bank_full, var))

bar_plot_matrix <- grid.arrange(grobs = plot_list, ncol = 3)
```

The bar chart matrix reveals a lot of useful information. Firstly, retired workers and students are most likely to subscribe to a deposit. Secondly, there are pronounced differences between the types of marital status of the reached clients. Thirdly, it is more probable that clients with a tertiary education will subscribe. Fourthly, clients with no financial burdens (defaults and loans) are more likely to subscribe. And lastly, March, September, October and December were the best months to contact the clients. Higher success could also be achieved when contacting the clients on the 1st, 10th, 22nd and 30th. Therefore, these insights should be tested when modelling.

We saw that call duration may be a factor in the deposit subscription rate. Let's look at the relationship it has with other continuous variables.

```{r message=FALSE, warning=FALSE}
p1 <- ggplot(bank_full, aes(x = log(duration), y = log(age))) +
  geom_point(alpha = 0.5) + 
  geom_smooth() +
  labs(title = "log(age) vs log(duration)") +
  theme_minimal()

p2 <- ggplot(bank_full, aes(x = log(duration), y = balance)) +
  geom_point(alpha = 0.5) +
  geom_smooth() +
  labs(title = "balance vs log(duration)") +
  theme_minimal()

p1 + p2
```

```{r}
cor(bank_full$duration, bank_full$balance)

cor(bank_full$duration, bank_full$age)
```

The graphs along with Pearson's correlation coefficient indicate that no correlation between call duration and balance/age exists.
